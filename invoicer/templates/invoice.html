{% extends "base.html" %}
{% load i18n %}

{% block title %}Invoice {{invoice.number}}/{{invoice.year}}{% endblock %}

{% block stylesheet %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}js/jqueryui/1.7/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/invoice.css" />
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}js/lightface/css/LightFace.css" />
    <!-- <link rel="stylesheet" type="text/css" href="{{ stylesheet.stylesheet.url }}" /> -->
{% endblock %}

{% block body_class %}invoice{% endblock %}

{% block header %}{% endblock %}
{% block nav %}{% endblock %}
{% block footer %}{% endblock %}
{% block scripts %}{{ block.super }}
<script type = "text/javascript" src = "{{ MEDIA_URL }}/js/jqueryui/1.7/jquery-ui.min.js"></script>
<script src="{{ MEDIA_URL }}js/jquerytools/1.1.2/tiny/jquery.tools.min.js"></script>

<script src="{{ MEDIA_URL }}js/mootools-core-1.3.2.js"></script>
<script src="{{ MEDIA_URL }}js/mootools-more-1.3.2.1.js"></script>

<script src="{{ MEDIA_URL }}js/lightface/LightFace.js"></script>
<script src="{{ MEDIA_URL }}js/lightface/LightFace.IFrame.js"></script>
<script src="{{ MEDIA_URL }}js/lightface/LightFace.Image.js"></script>
<script src="{{ MEDIA_URL }}js/lightface/LightFace.Request.js"></script>
<script src="{{ MEDIA_URL }}js/lightface/LightFace.Static.js"></script>

<script type="text/javascript">

    editInvoice = function(element, oldValue, newValue) {

        var data = {};

        // gather data for invoice
        var invoice_fields = $$(".invoice_field");
        invoice_fields.each(function(field){
            var id = field.get("id");
            if (id) data[id] = field.get("text");
        });

        // gather the data for each item row
        var trs = $$("tr.item-row");
        trs.each(function(tr){
            data[tr.get("id")] = tr.get("name");
            var tds = tr.getChildren("td");
            tds.each(function(td){
                var id = td.get("id");
                if (id) data[id] = td.get("text");
            });
        });

        //add in the required formset fields
        data["{{formset.management_form.TOTAL_FORMS.html_name}}"] = document.id("id_{{ formset.management_form.TOTAL_FORMS.html_name }}").get("value");
        data["{{formset.management_form.INITIAL_FORMS.html_name}}"] = document.id("id_{{ formset.management_form.INITIAL_FORMS.html_name }}").get("value");

        // update value for selected element
        data[element.get("id")] = newValue;

        //send along the id and value so we know what was edited
        data["_element_id"] = element.get("id");
        data["_value"] = newValue;

        //correct for false == empty logic in django form processing
        for (key in data) {
            if (key.indexOf("taxable") !== -1 && data[key] !== "Y"){
                data[key] = "";
            }
        }

        // submit the data
        var url = "{% url invoicer:edit_invoice invoice.year invoice.number %}";
        var request = new Request.JSON({
            url:url,
            method:'post',
            data:data,
            onSuccess: function(result){
                processEditInvoiceResult(result);
            }.bind(this),
            onFailure: function(result){
                alert('failure:' + result.responseText);
            }.bind(this)
        }).send();
    },

    processEditInvoiceResult = function(result) {
        if ( result.status=='success') {
            var element = document.id(result.element_id);
            element.set('text', result.value);
            if ( element.hasClass('recalc') ) {
                recalcRow(element);
            }
        }
        else {
            var text = result.status;
            text += '\n\n';
            for ( var key in result.errors ) {
                text += key + ': ' + result.errors[key] + '\n';
            }
            alert(text);
        }
    },

    recalcRow = function(element) {
        var parent = element.getParent();
        var price = parseFloat(parent.getChildren('.price').get('text'));
        var quantity = parseFloat(parent.getChildren('.quantity').get('text'));
        var ext_price = price * quantity;
        parent.getChildren(".price").set('text', price.toFixed(2));
        parent.getChildren(".quantity").set('text', quantity.toFixed(2));
        parent.getChildren(".ext_price").set('text', ext_price.toFixed(2));
        calculateTotals();
    },

    calculateTotals = function() {
        var table = document.id('items');
        var tax_rate = parseFloat(table.getElement('span.tax_rate').get('text')) / 100.0;
        var subtotal = 0.0;
        var tax = 0.0;

        var trs = table.getElements("tr.item-row");
        trs.each(function(row) {
            var ext = parseFloat(row.getElement('.ext_price').get('text'));
            var taxable = row.getElement('.taxable').get('text');
            if ( taxable == "Y" ) {
                tax += ext * tax_rate;
            }
            subtotal += ext;
        });

        table.getElement('.total-value.subtotal').set('text', subtotal.toFixed(2));
        table.getElement('.total-value.tax').set('text', tax.toFixed(2));
        table.getElement('.total-value.total').set('text', (subtotal+tax).toFixed(2));
    },

    // adapted from http://davidwalsh.name/editable-content-mootools-php-mysql
    window.addEvent('domready', function() {

        //find the editable areas
        $$('.editable').each(function(el) {
            if ( el.get('text')=='' ) {
                el.addClass('editable-empty');
            }
            //add double-click and blur events
            el.addEvent('dblclick',function() {
                //store "before" message
                var before = el.get('html').trim();
                //erase current
                el.set('html','');
                //replace current text/content with input or textarea element
                if(el.hasClass('textarea'))
                {
                    var input = new Element('textarea', { 'class':'box', 'text':before });
                    input.store('before', before);
                    input.addEvent('keydown', function(e) { if(e.key == 'esc') { this.store('cancelled', 1); this.fireEvent('blur'); } });
                }
                else
                {
                    var input = new Element('input', { 'class':'box', 'value':before });
                    input.store('before', before);
                    //blur input when they press "Enter"
                    input.addEvent('keydown', function(e) { if (e.key=='esc') this.store('cancelled',1); if(e.key=='enter' || e.key=='esc') { this.fireEvent('blur'); } });
                }
                input.inject(el).select();
                //add blur event to input
                input.addEvent('blur', function() {
                    if ( this.retrieve('cancelled',0) ) {
                        el.set('text', this.retrieve('before', ''));
                        return;
                    }
                    var oldValue = this.retrieve('before','');
                    var newValue = input.get('value').trim();
                    //get value, place it in original element
                    el.set('text',oldValue).addClass(newValue != '' ? '' : 'editable-empty');
                    editInvoice(el, oldValue, newValue);
                });
            });
        });

        /* create LightFace instance */
        var modal = new LightFace({
            width: 400,
            height: 200,
            draggable: true,
            title: 'Hello from LightFace!',
            content: '<p>This is the LightFace content!</p>',
            buttons: [
                { title: 'Close', event: function() { this.close(); }, color: 'blue' }
            ],
            resetOnScroll: true
        });

        // open when link is clicked
        document.id('testLightFace').addEvent('click',function(e){
            e.stop();
            modal.open();
        });

        document.id('testLightFaceRequest').addEvent('click',function(){
            
            ajaxFace = new LightFace.Request({
                buttons: [
                    { title: 'Submitter', event: function() { alert('hi!'); }, color: 'blue' },
                    { title: 'Canceler', event: function() { this.close(); } }
                ],
                url: '{% url invoicer:add_line invoice.year invoice.number %}',
                request: { 
                    data: { 
                        name: 'mario'
                    },
                    method: 'get'
                },
                title: 'AJAX Demo',
                width: 350,
                height: 250,
                draggable: true,
            }).open();
            
        });

        /* create LightFace instance */
        var modal2 = new LightFace.Request({
            width: 600,
            height: 400,
            draggable: true,
            title: 'Hello from LightFace!',
            content: '<p>This is the LightFace content!</p>',
            buttons: [
                { title: 'Close', event: function() { this.close(); }, color: 'blue' }
            ],
            resetOnScroll: true
        });

        // open when link is clicked
        document.id('testLightFaceRequestCustomized').addEvent('click',function(e){
            e.stop();
            modal2.open();
            var form = document.id('add-modal');
            modal2.load(form.get('html'),'This is the title!');
            var url = '{% url invoicer:add_line invoice.year invoice.number %}';
            var container = document.id('add-modal').getElement('.container');
            modal2.loadex(url, 'get', {}, container);
        });

    });

</script>

<script type="text/javascript">
/*
$(function(){
    var indicator = 'Saving...',
        rows = jQuery("#items tr.item-row"),
        renumber_rows = function () {
            var table = jQuery("#items");
            table.find("tr.item-row").each(function (i){
                var row = jQuery(this),
                    bits = row.attr("id").split("-");
                bits[1] = i;
                row.attr("id", bits.join("-"));
                row.find("td").each(function (j){
                    var td = jQuery(this),
                        pieces = td.attr("id").split("-");
                    pieces[1] = i;
                    td.attr("id", pieces.join("-"));
                });
            });
        }

    jQuery("#items tr.item-row").tooltip({
        tip: "#row-tools",
        delay: 750,
        predelay: 250,
        position: "top right",
        effect: "fade",
        offset: [15, -25],
        api: true,
        lazy: true,
        onBeforeShow: function(pos) {
            var row = this.getTrigger().closest("tr.item-row");
            jQuery("#trigger-row-id").attr("value", row.attr("id"));
        }
    });

    jQuery("#row-tools a.delete-button").overlay({
        target: "#confirm-delete",
        expose: {
            color: '#333',
            loadSpeed: 200,
            opacity: 0.9
        }
    });

    jQuery("#row-tools a.add-button").overlay({
        target: "#add-modal",
        expose: {
            color: '#333',
            loadSpeed: 200,
            opacity: 0.9
        },
        onBeforeLoad: function () {
            var container = this.getContent().find("table.container");
            container.load("{% url invoicer:add_line invoice.year invoice.number %}");
        }
    });

    jQuery("#confirm-delete button.confirm").click(function () {
        var id = jQuery("#trigger-row-id").attr("value"),
            row = jQuery("#" + id),
            td = row.find("td.delete"),
            checkbox = row.find("td.delete input:checkbox");
        checkbox.attr("checked", true);
        ajaxEdit.apply(td, ["DELETE"]);
    });
    jQuery("#id_{{ formset.management_form.TOTAL_FORMS.html_name }}").attr("value", rows.length);
    jQuery("#id_{{ formset.management_form.INITIAL_FORMS.html_name }}").attr("value", rows.length);
});
    */

</script>
{% endblock %}

{% block content %}
    <div id="invoice-wrapper">
        <div id="logo">
            <ul>
                <li><a id="testLightFace" href="#">test LightFace</a></li>
                <li><a id="testLightFaceRequest" href="#">test LightFaceRequest</a></li>
                <li><a id="testLightFaceRequestCustomized" href="#">test LightFaceRequest customized</a></li>
            </ul>
            <img alt="{{invoice.company.name}}" src="{{invoice.company.logo.url}}" />
        </div>
        <div id="header">
            <table>
                <tbody>
                <tr>
                    <td>
                        <div>{{invoice.location}}, {{invoice.invoice_date|date:"DATE_FORMAT"}}</div>
                        <div>Fattura n. {{invoice.number}}/{{invoice.year}}</div>
                        <br />
                        <div>Cliente:</div>
                        <div>{{invoice.client.name}}</div>
                        {% if invoice.client.vat_id %}
                            <div>{% trans 'VAT ID' %}: {{invoice.client.vat_id}}</div>
                        {% endif %}
                        {% if invoice.client.fiscal_code %}
                            <div>{% trans 'Fiscal Code' %}: {{invoice.client.fiscal_code}}</div>
                        {% endif %}
                        <div id="left_address" class="invoice_field editable textarea">{{invoice.left_address|linebreaksbr}}</div>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                        <div>{{invoice.client.name}}</div>
                        <div id="right_address" class="invoice_field editable textarea">{{invoice.right_address|linebreaksbr}}</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="body">
            {{ formset.management_form }}
            <input type="hidden" id="trigger-row-id" value="" />
            <table id="items">
                <thead>
                <tr>
                    <th class="item" >&nbsp;</th>
                    <th class="price">Prezzo unitario</th>
                    <th class="quantity">Quantità</th>
                    <th class="ext_price">Prezzo totale</th>
                    <th class="taxable blank">{%if not compact%}Taxable{%endif%}</th>
                    <th class="delete blank"></th>
                </tr>
                </thead>
                <tbody>
                {% for form in formset.forms %}
                    <tr id="{{form.id.html_name}}" name="{{form.instance.id}}" class="item-row">
                        <!-- <td id="{{form.name.html_name}}" class="item text edit">{{form.initial.name}}<div id="{{form.description.html_name}}" class="description text edit">{{form.initial.description}}</div></td> -->
                        <td id="{{form.name.html_name}}" class="item editable textarea">{{form.initial.name|linebreaks}}</td>
                        <td id="{{form.price.html_name}}" class="numeric price editable recalc">{{ form.initial.price|floatformat:2 }}</td>
                        <td id="{{form.quantity.html_name}}" class="numeric quantity editable recalc">{{ form.initial.quantity }}</td>
                        <td class="numeric ext_price">{{ form.instance.ext_price|floatformat:2 }}</td>
                        <td id="{{form.taxable.html_name}}" class="taxable editable recalc {%if compact%}concealed{%endif%}">{{ form.initial.taxable|yesno:"Y,N" }}</td>
                        <td id="{{form.DELETE.html_name}}" class="delete">
                            <input type="checkbox" name="{{form.DELETE.html_name}}"></input>
                        </td>
                    </tr>
                {% endfor %}
                <tr><td colspan="4" class="blank">&nbsp;</td></tr>
                <tr>
                    <td class="blank"> </td>
                    <td colspan="2" class="total-line">Totale imponibile</td>
                    <td class="numeric total-value subtotal">{{ invoice.subtotal|floatformat:2 }}</td>
                    <td colspan="2" class="blank"> </td>
                </tr>
                <tr>
                    <td class="blank"> </td>
                    <td colspan="2" class="total-line">IVA (<span class="tax_rate">{{ invoice.company.tax_rate }}</span>%)</td>
                    <td class="numeric total-value tax">{{ invoice.tax|floatformat:2 }}</td>
                    <td colspan="2" class="blank"> </td>
                </tr>
                <tr>
                    <td class="blank"> </td>
                    <td colspan="2" class="total-line bold">TOTALE</td>
                    <td class="numeric total-value total bold">{{ invoice.total|floatformat:2 }}</td>
                    <td colspan="2" class="blank"> </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="terms">
            <br />
            <div>terms</div>
            <div>terms</div>
            <div>terms</div>
        </div>
        <div id="footer">
            {{ invoice.footer }}
        </div>
    <div>

    {% comment %}
    <form id="payment-status">
        <fieldset>
            <legend>Invoice Status</legend>
            <h3>{{ invoice.get_status_display }}</h3>
        </fieldset>
    </form>
    {% endcomment %}

    {% comment %}
    <div id="info">
        {% if invoice.terms.description %}<p class="edit area nosave">{{ invoice.terms.description }}</p>{% endif %}
        {% if stylesheet.misc_text %}<p class="edit area nosave">{{ stylesheet.misc_text }}</p>{% endif %}
        {% if stylesheet.feedback_text %}<p class="edit area nosave">{{ stylesheet.feedback_text }}</p>{% endif %}
        {% if stylesheet.thank_you_text %}<p class="edit area nosave">{{ stylesheet.thank_you_text }}</p>{% endif %}
    </div>
    {% endcomment %}

    <div id="confirm-delete" class="dialog">
        <h2>Delete Row</h2>
        <p>This row will be permanently deleted and cannot be recovered. Are you sure?</p>
        <p>
            <button class="close">Cancel</button>
            <button class="close confirm">Delete</button>
        </p>
    </div>

    <div id="add-modal" class="dialog">
        <form id="add-form" method="POST" action="{% url invoicer:add_line invoice.year invoice.number %}">
            <input type="hidden" name="invoice" value="{{ invoice.id }}" />
            <h2>Add Row</h2>
            <table class="container"></table>
            <p>
                <button class="close">Cancel</button>
                <button type="reset">Reset</button>
                <button type="submit" class="close confirm">Add</button>
            </p>
        </form>
    </div>

    <div id="row-tools" class="tooltip">
        <span><a href="#add" class="add-button">Add</a> | <a href="#delete" class="delete-button">Delete</a></span>
    </div>

{% endblock %}
